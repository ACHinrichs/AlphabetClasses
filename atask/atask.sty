\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{atask}[2017/05/04 A Task Package]
\RequirePackage{xifthen}
\RequirePackage{etoolbox}
\RequirePackage{kvoptions}
\RequirePackage{suffix}
\SetupKeyvalOptions{family=atask,prefix=atask@}
\DeclareStringOption[arabic]{aufgabeCounter}
\DeclareStringOption[alph]{teilaufgabeCounter}
\RequirePackage{translations}
\makeatletter
\newcommand{\atask}{\textsc{aTask} }
\newcounter{aufgabe} \setcounter{aufgabe}{0}
\newcounter{teilaufgabe}[aufgabe] \setcounter{teilaufgabe}{0}
% \counterwithin{table}{aufgabe}
% \counterwithin{figure}{aufgabe}
\DeclareTranslation{English}{aufgabe}{Exercise}
\DeclareTranslation{English}{teilaufgabe}{Subtask}
\DeclareTranslation{German}{aufgabe}{Aufgabe}
\DeclareTranslation{German}{teilaufgabe}{Teilaufgabe}
\DeclareTranslationFallback{aufgabe}{Aufgabe}
\DeclareTranslationFallback{teilaufgabe}{Teilaufgabe}
\newcommand{\@aufgabestil}{\Large\ifstrempty{\@headingstyling}{\bfseries\sffamily}{\@headingstyling}\raggedright}
\newcommand{\aufgabenstil}[1]{\renewcommand{\@aufgabenstil}{#1}}
\newcommand{\@teilaufgabestil}{\large\ifstrempty{\@headingstyling}{\bfseries\sffamily}{\@headingstyling}\raggedright}
\newcommand{\teilaufgabestil}[1]{\renewcommand{\@teilaufgabestil}{#1}}

\newcommand{\@marginBeforeAufgabe}{-2em \@plus -1em \@minus -1em}
\newcommand{\@marginAfterAufgabe}{1ex \@plus .5ex}
\newcommand{\@marginBeforeTeilaufgabe}{-1em \@plus -.5em \@minus -.5em}
\newcommand{\@marginAfterTeilaufgabe}{.5ex \@plus .5ex}
\newcommand{\marginBeforeAufgabe}[1]{\renewcommand{\@marginBeforeAufgabe}{#1}}
\newcommand{\marginAfterAufgabe}[1]{\renewcommand{\@marginAfterAufgabe}{#1}}
\newcommand{\marginBeforeTeilaufgabe}[1]{\renewcommand{\@marginBeforeTeilaufgabe}{#1}}
\newcommand{\marginAfterTeilaufgabe}[1]{\renewcommand{\@marginAfterTeilaufgabe}{#1}}

\newcommand{\atask@aufgabe}{\arabic{aufgabe}}
\newcommand{\atask@teilaufgabe}{\alph{teilaufgabe}}
\newcommand{\atask@parseCounterStyle}[3]{
  \ifthenelse{\equal{#1}{arabic}}{ \renewcommand{#2}{\arabic{#3}} }{
    \ifthenelse{\equal{#1}{roman}}{ \renewcommand{#2}{\roman{#3}} }{
      \ifthenelse{\equal{#1}{alph}}{ \renewcommand{#2}{\alph{#3}} }{
        \ifthenelse{\equal{#1}{Alph}}{ \renewcommand{#2}{\Alph{#3}} }{
          \ifthenelse{\equal{#1}{Roman}}{
            \renewcommand{#2}{\Roman{#3}} }{
            \ClassError{atask}{Invalid Value #1 for
              option Counter-Styling}{Possible Values are alph,
              arabic, Arabic, roman or Roman.}  } } } } } }
\atask@parseCounterStyle{\atask@aufgabeCounter}{\atask@aufgabe}{aufgabe}
\atask@parseCounterStyle{\atask@teilaufgabeCounter}{\atask@teilaufgabe}{teilaufgabe}

\newcommand{\newaufgabe}[1]{%
  \refstepcounter{section}
  \refstepcounter{aufgabe}%
  \label{aufgabe:\theaufgabe}%
  \def\@aufgabentitel{\GetTranslation{aufgabe}\ \atask@aufgabe\ifstrempty{#1}{}{\ (#1)}}%
  \@startsection{aufgabe}%
    {1}%
    {\z@}%
    {\@marginBeforeAufgabe}%
    {\@marginAfterAufgabe}%
    {\@aufgabestil}%
    *{\@aufgabentitel} \addcontentsline{toc}{section}{\@aufgabentitel}%
}
\newcommand{\newteilaufgabe}[1]{%
  \refstepcounter{subsection}
  \refstepcounter{teilaufgabe}%
  \label{teilaufgabe:\theaufgabe_\theteilaufgabe}%
  \def\@teilaufgabentitel{\GetTranslation{teilaufgabe}\ \atask@aufgabe.\atask@teilaufgabe\ifstrempty{#1}{}{\ (#1)}}%
  \@startsection{teilaufgabe}%
    {2}%
    {\z@}%
    {\@marginBeforeTeilaufgabe}%
    {\@marginAfterTeilaufgabe}%
    {\@teilaufgabestil}%
    *{\@teilaufgabentitel} \addcontentsline{toc}{subsection}{\@teilaufgabentitel}%
}

\newcommand{\aufgabe}[1]{\newaufgabe{#1}}

\WithSuffix\newcommand\aufgabe*[2][]{%
  \ifthenelse{\equal{#1}{}}{ }{\setcounter{aufgabe}{#1}\setcounter{section}{#1}}
  \newaufgabe{#2}
}
\newcommand{\teilaufgabe}[1]{\newteilaufgabe{#1}}

\WithSuffix\newcommand\teilaufgabe*[2][]{%
  \ifthenelse{\equal{#1}{}}{ }{\setcounter{teilaufgabe}{#1}\setcounter{subsection}{#1}}
  \newteilaufgabe{#2}
}
\makeatother
\endinput
